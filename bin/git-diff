#!/bin/bash
#
# git-diff
#
# Computes git diff between current branch and a base branch
#
# Usage: git-diff <base-branch>

# Check for base branch argument
if [ -z "$1" ]; then
    echo "Error: Base branch argument required" >&2
    echo "Usage: git-diff <base-branch>" >&2
    exit 1
fi

BASE_BRANCH="$1"

# Change to repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

# Get current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Fetch remote
git fetch --all

# Find merge base
MERGE_BASE=$(git merge-base HEAD "$BASE_BRANCH")

if [ -z "$MERGE_BASE" ]; then
    echo "Error: Could not find merge base between HEAD and $BASE_BRANCH" >&2
    exit 1
fi

# Get changed files
CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD)

if [ -z "$CHANGED_FILES" ]; then
    echo "Error: No changed files found between $MERGE_BASE and HEAD" >&2
    exit 1
fi

# Filter out lock files
FILTERED_FILES=$(echo "$CHANGED_FILES" | grep -v -E '(package-lock\.json|yarn\.lock|pnpm-lock\.yaml|Gemfile\.lock|Cargo\.lock|composer\.lock|poetry\.lock|go\.sum|\.lock)$')

if [ -z "$FILTERED_FILES" ]; then
    echo "Error: No non-lock files changed between $MERGE_BASE and HEAD" >&2
    exit 1
fi

# Get full diff for non-lock files only
DIFF=$(git diff "$MERGE_BASE" HEAD -- $FILTERED_FILES)

# Output diff to stdout
echo "$DIFF"